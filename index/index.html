<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <meta name="theme-color" content="#0b0b16" />
  <title>Ember Chat</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap"
    rel="stylesheet"
  />

  <!-- Styles -->
  <link rel="stylesheet" href="./style.css" />

  <!-- Favicon (optional) -->
  <link
    rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2744%27 fill=%27%238b5cf6%27/%3E%3Ctext x=%2750%27 y=%2758%27 font-size=%2750%27 text-anchor=%27middle%27 fill=%27white%27 font-family=%27Verdana%27%3E%E1%B4%87%3C/text%3E%3C/svg%3E"
  />

  <style>
    html { scroll-behavior: smooth; }
    .container { width: min(1200px, 94vw); margin: 0 auto; }
    .hero { padding: 3rem 0 1rem; }
    .kicker { color: var(--text-secondary, #a1a1c1); letter-spacing: 0.08em; text-transform: uppercase; font-size: 0.8rem; }
    .cta-row { display:flex; gap:12px; flex-wrap:wrap; margin-top:1rem; }
    .btn { appearance:none; border:none; border-radius:.75rem; padding:.65rem .9rem; font-weight:700; cursor:pointer; transition: transform .05s ease-out, filter .2s ease; }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--accent,#8b5cf6); color:#fff; }
    .btn-primary:hover{ filter:brightness(1.08); }
    .btn-soft{ background:rgba(255,255,255,0.06); color:var(--text-primary,#e7e8ee); border:1px solid rgba(255,255,255,0.08); }
    .section-title{ margin:0 0 .5rem; font-size:1.6rem; }
    .muted{ color:var(--text-secondary,#a1a1c1); }
    footer{ padding:24px 16px; text-align:center; color:var(--text-secondary,#a1a1c1); }
    .status{ display:inline-flex; align-items:center; gap:8px; font-size:.9rem; color:var(--text-secondary,#a1a1c1); margin-top:8px; }
    .dot{ width:10px; height:10px; border-radius:50%; background:#ef4444; box-shadow:0 0 10px rgba(239,68,68,.5); }
    .note{ font-size:.9rem; color:var(--text-secondary,#a1a1c1); margin-top:6px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); color:var(--text-primary,#e7e8ee); font-size:.85rem; text-decoration:none; }
    .chip:hover{ filter: brightness(1.08); }

    /* Ensure avatar area has size even if external CSS changes */
    #scene-container {
      width: 100%;
      max-width: 100%;
      height: 420px;           /* explicit height fixes “invisible canvas” */
      min-height: 240px;
      background: #0f0f1a;
      border: 1px solid #222;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    /* Small inline styles for mode selector row */
    #mode-row {
      display:flex; gap:10px; align-items:center; margin:10px 0 6px;
      color: var(--text-secondary, #a1a1c1);
    }
    #mode-select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(20,20,30,0.7);
      color: #e7e8ee;
    }
  </style>
</head>
<body>
  <a href="#main" class="sr-only">Skip to content</a>

  <header>
    <nav class="container" aria-label="Primary">
      <ul>
        <li><a href="#intro">Home</a></li>
        <li><a href="#visualizer">Visualizer</a></li>
        <li><a href="#chat">Chat</a></li>
        <li><a href="#about">About</a></li>
      </ul>
    </nav>
  </header>

  <main id="main" class="container">
    <!-- Intro / Hero -->
    <section id="intro" class="hero" aria-labelledby="intro-title">
      <p class="kicker">Neural • Ember</p>
      <h1 id="intro-title" style="margin:.25rem 0 0.5rem;">Ember Chat</h1>
      <p class="muted" style="max-width: 70ch;">
        Welcome to Ember Chat — a lightweight web client for talking to your local AI.
        Connect to your backend server, send messages, and optionally augment replies
        with web search. Below you’ll find a real-time 3D visualizer (powered by
        <strong>three.js</strong>), and a polished chat interface.
      </p>
      <div class="cta-row">
        <a class="btn btn-primary" href="#chat">Open Chat</a>
        <a class="btn btn-soft" href="#visualizer">See Visualizer</a>
      </div>
      <div class="chips" aria-label="Quick links">
        <a class="chip" href="#about" title="Learn more">About</a>
        <a class="chip" href="https://github.com/" target="_blank" rel="noreferrer">GitHub</a>
        <span class="status" aria-live="polite">
          <span class="dot" id="api-dot" aria-hidden="true"></span>
          <span>API status: <strong id="api-status">Unknown</strong></span>
        </span>
      </div>
      <p class="note">Tip: configure your API base in the Chat section, then hit “Save”.</p>
    </section>

    <!-- Visualizer -->
    <section id="visualizer" aria-labelledby="viz-title">
      <h2 id="viz-title" class="section-title">3D Visualizer</h2>
      <p class="muted" style="max-width: 70ch;">
        A simple animated scene you can tweak. Change color, play with rotation,
        toggle wireframe, and reset the camera.
      </p>

      <div id="scene-container" role="img" aria-label="Interactive 3D scene"></div>

      <div id="scene-controls" aria-label="Visualizer controls">
        <label for="cube-color">Cube Color</label>
        <input type="color" id="cube-color" value="#ff0000" aria-label="Cube color" />

        <label for="rotation-speed">Rotation Speed</label>
        <input
          type="range"
          id="rotation-speed"
          min="0" max="0.1" step="0.001" value="0.01"
          aria-label="Rotation speed"
        />

        <button id="toggle-rotation" class="btn btn-soft" type="button" aria-pressed="true">
          Pause Rotation
        </button>
        <button id="toggle-wireframe" class="btn btn-soft" type="button">
          Toggle Wireframe
        </button>
        <button id="reset-view" class="btn btn-soft" type="button">
          Reset View
        </button>
      </div>
    </section>

    <!-- Chat -->
    <section id="chat" aria-labelledby="chat-title">
      <div id="chat-container" aria-live="polite">
        <h2 id="chat-title" class="section-title">Chat</h2>
        <p class="muted" style="margin-top:-4px; max-width: 70ch;">
          Point this client at your local API, then start chatting. If your API isn’t reachable
          (e.g., on GitHub Pages over HTTPS), you can switch to the in-browser model.
        </p>

        <!-- Mode picker (works with main.js) -->
        <div id="mode-row">
          <label for="mode-select">Mode:</label>
          <select id="mode-select" aria-label="Chat mode">
            <option value="auto" selected>Auto (API → Browser)</option>
            <option value="api">API only</option>
            <option value="webllm">Browser (WebLLM) only</option>
          </select>
        </div>

        <!-- HTTPS note (mixed-content helper) -->
        <div id="https-note" class="note" style="display:none;">
          You are on <strong>HTTPS</strong>. Browsers block requests to <code>http://localhost:8000</code>.
          Use the “Browser (WebLLM) only” mode, run your API with HTTPS, or test locally (file://).
        </div>

        <!-- API base control -->
        <div id="server" role="group" aria-labelledby="server-label">
          <label id="server-label" for="api-base" class="sr-only">API base URL</label>
          <input
            id="api-base"
            type="text"
            inputmode="url"
            placeholder="API base URL (e.g., http://localhost:8000)"
            aria-describedby="api-help"
          />
          <button id="save-api" class="btn btn-primary" type="button">Save</button>
        </div>
        <div id="api-help" class="note">
          This is where requests are sent. The value is stored locally in your browser.
        </div>

        <!-- Messages -->
        <div id="chat-box" aria-label="Conversation transcript"></div>

        <!-- Options -->
        <div id="options" role="group" aria-label="Augmentation">
          <label for="use-web" style="display:inline-flex;align-items:center;gap:8px;">
            <input type="checkbox" id="use-web" /> Enable web search
          </label>
          <input
            id="web-query"
            type="text"
            placeholder="Custom web query (optional)"
            aria-label="Custom web query"
          />
        </div>

        <!-- Input bar -->
        <div id="input-bar">
          <label class="sr-only" for="message">Your message</label>
          <input
            id="message"
            type="text"
            placeholder="Type a message"
            aria-label="Message"
            autocomplete="off"
          />
          <button id="send" class="btn btn-primary" type="button">Send</button>
        </div>

        <p class="note">Shortcut: press <strong>Enter</strong> to send (Shift+Enter for newline).</p>
      </div>
    </section>

    <!-- About -->
    <section id="about" aria-labelledby="about-title">
      <h2 id="about-title" class="section-title">About</h2>
      <p class="muted" style="max-width: 70ch;">
        Ember Chat is an experiment in approachable interfaces for local AI models.
        This page blends a simple conversational UI with a WebGL visualizer to show
        how traditional web apps and GPU graphics can complement each other.
      </p>
      <p class="muted" style="max-width: 70ch;">
        The chat client stores history locally in your browser, and the API base URL
        you set is also saved locally. No third-party services are required unless
        you enable web search on the server side.
      </p>
    </section>
  </main>

  <footer>
    <p>&copy; 2024 Ember Chat. All rights reserved.</p>
  </footer>

  <noscript>
    <div style="padding:12px; text-align:center; color:#fca5a5;">
      JavaScript is disabled. Enable it to use the visualizer and chat client.
    </div>
  </noscript>

  <!-- Scripts (defer so DOM is ready) -->
  <script defer src="https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.min.js"></script>

  <!-- WebLLM (browser model) — required for “Browser only” and Auto fallback -->
  <script defer src="https://unpkg.com/@mlc-ai/web-llm@0.2.70/dist/index.min.js"></script>

  <!-- Inline fixes: Enter-to-send + HTTPS note + avatar size guard -->
  <script defer>
    document.addEventListener('DOMContentLoaded', function () {
      // Enter to send (keydown is reliable across browsers)
      const msg = document.getElementById('message');
      const send = document.getElementById('send');
      if (msg && send) {
        msg.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send.click();
          }
        });
      }

      // HTTPS mixed-content helper (show only if on https)
      const httpsNote = document.getElementById('https-note');
      if (location.protocol === 'https:') {
        httpsNote.style.display = 'block';
      }

      // Ensure avatar container has a height even if CSS fails to load
      const c = document.getElementById('scene-container');
      if (c && (!c.style.height || c.clientHeight < 40)) {
        c.style.height = '420px';
      }
    });
  </script>

  <!-- Main client logic (after Three.js & WebLLM) -->
  <script defer src="./main.js"></script>

  <!-- Lightweight status probe for the hero “API status” -->
  <script defer>
    (async function probe() {
      const dot = document.getElementById('api-dot');
      const label = document.getElementById('api-status');
      try {
        const base =
          new URLSearchParams(location.search).get('api') ||
          localStorage.getItem('api-base') ||
          localStorage.getItem('ember.apiBase') ||
          'http://localhost:8000';
        const r = await fetch(base.replace(/\/+$/,'') + '/health', { method: 'GET' });
        if (r.ok) {
          dot.style.background = '#22c55e'; // green
          dot.style.boxShadow = '0 0 10px rgba(34,197,94,.6)';
          label.textContent = 'Available';
        } else {
          dot.style.background = '#f59e0b'; // amber
          dot.style.boxShadow = '0 0 10px rgba(245,158,11,.6)';
          label.textContent = 'Unresponsive';
        }
      } catch {
        dot.style.background = '#ef4444'; // red
        dot.style.boxShadow = '0 0 10px rgba(239,68,68,.6)';
        label.textContent = 'Offline';
      }
    })();
  </script>
</body>
</html>